{% extends "layout/base.html" %}

{% block title %}
Upload and Search Files
{% endblock %}

{% block content %}
    <h1 class="text-center mb-4">Upload ZIP File</h1>
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="fileUpload">Select a ZIP file:</label>
            <input type="file" class="form-control-file" id="fileUpload" name="file" accept=".zip" required>
        </div>
        <button type="submit" class="btn btn-primary">Upload</button>
    </form>

    <h2 class="text-center mt-5">Search Files</h2>
    <div class="form-group">
        <input type="text" id="searchField" class="form-control" placeholder="Search files by name, type or source zip">
    </div>

    <h3 class="mt-4">Files:</h3>
    <ul id="fileList" class="list-group">
        <!-- Dynamically populated list of files -->
    </ul>

    <!-- View Content Modal -->
    <div class="modal" id="viewContentModal" tabindex="-1" role="dialog" aria-labelledby="viewContentModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewContentModalLabel">File Content</h5>
                    <!-- <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button> -->
                </div>
                <div class="modal-body">
                    <pre id="fileContent">Loading...</pre>
                </div>
                <!-- <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div> -->
            </div>
        </div>
    </div>

    {% if error %}
        <p class="error-message mt-3">{{ error }}</p>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Function to fetch files from the server
        function fetchFiles(query = '') {
            $.ajax({
                url: '/search/',
                type: 'GET',
                data: { q: query },
                success: function(response) {
                    var fileList = $('#fileList');
                    fileList.empty();

                    if (response.files && response.files.length > 0) {
                        response.files.forEach(function(file) {
                            var listItem = `
                                <li class="list-group-item">
                                    <strong>File Name:</strong> ${file.file_name} <br>
                                    <strong>File Type:</strong> ${file.file_type} <br>
                                    <strong>File Size:</strong> ${file.file_size} bytes <br>
                                    <strong>Source Zip File Name:</strong> ${file.source_zip_file_name} <br>
                                    <button class="btn btn-info btn-sm float-right" onclick="viewFileContent('${file.obj_storage_id}')">View</button>
                                    <a href="/download/${file.obj_storage_id}" class="btn btn-secondary btn-sm float-right mr-2" target="_blank">Download</a>
                                </li>`;

                            fileList.append(listItem);
                        });
                    } else {
                        fileList.append('<li class="list-group-item">No matching files found</li>');
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    showSnackbar("Search failed: " + errorThrown);
                }
            });
        }

        fetchFiles();

        // Function to view file content
        window.viewFileContent = function(obj_storage_id) {
            $('#loadingModal').modal('show'); // Show the loader

            $.ajax({
                url: `/view/${obj_storage_id}`,
                type: 'GET',
                success: function(response) {
                    $('#fileContent').text(response.file_content);
                    $('#viewContentModal').modal('show');
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    showSnackbar("Failed to fetch file content: " + errorThrown);
                },
                complete: function() {
                    $('#loadingModal').modal('hide'); // Hide the loader when done
                }
            });
        };

        // Function to show snackbar messages
        function showSnackbar(message) {
            var snackbar = $('#snackbar');
            snackbar.text(message);
            snackbar.addClass('show');
            setTimeout(function() {
                snackbar.removeClass('show');
            }, 3000);
        }

        // Handle form submission
        $('#uploadForm').on('submit', function(e) {
            e.preventDefault();

            var formData = new FormData(this);
            $('#loadingModal').modal('show'); // Show the loader

            $.ajax({
                url: '/upload/',
                type: 'PUT',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    showSnackbar("File uploaded successfully!");
                    fetchFiles();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    showSnackbar("Failed to upload file: " + errorThrown);
                },
                complete: function() {
                    $('#loadingModal').modal('hide'); // Hide the loader
                }
            });
        });

        // Handle search input
        $('#searchField').on('input', function() {
            var query = $(this).val();
            fetchFiles(query);
        });
    });
</script>
{% endblock %}
