{% extends "layout/base.html" %}

{% block title %}
Upload and Search Files
{% endblock %}

{% block content %}
    <h1 class="text-center mb-4">Upload ZIP File</h1>
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="fileUpload">Select a ZIP file:</label>
            <input type="file" class="form-control-file" id="fileUpload" name="file" accept=".zip" required>
        </div>
        <button type="submit" class="btn btn-primary">Upload</button>
    </form>

    <h2 class="text-center mt-5">Search Files</h2>
    <div class="form-group">
        <input type="text" id="searchField" class="form-control" placeholder="Search files by name, type or source zip">
    </div>

    <h3 class="mt-4">Files:</h3>
    <ul id="fileList" class="list-group">
        <!-- Dynamically populated list of files -->
    </ul>

    {% if error %}
        <p class="error-message mt-3">{{ error }}</p>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        function fetchFiles(query = '') {
            $.ajax({
                url: '/search/',
                type: 'GET',
                data: { q: query },
                success: function(response) {
                    var fileList = $('#fileList');
                    fileList.empty();

                    if (response.files && response.files.length > 0) {
                        response.files.forEach(function(file) {
                            var listItem = `
                                <li class="list-group-item">
                                    <strong>File Name:</strong> ${file.file_name} <br>
                                    <strong>File Type:</strong> ${file.file_type} <br>
                                    <strong>File Size:</strong> ${file.file_size} bytes <br>
                                    <a href="/view/${file.file_name}" class="btn btn-primary btn-sm float-right ml-2" target="_blank">View</a>
                                    <a href="/download/${file.file_name}" class="btn btn-secondary btn-sm float-right">Download</a>
                                </li>`;
                            fileList.append(listItem);
                        });
                    } else {
                        fileList.append('<li class="list-group-item">No matching files found</li>');
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    showSnackbar("Search failed: " + errorThrown);
                }
            });
        }

        // Fetch all files on page load
        fetchFiles();

        $('#uploadForm').on('submit', function(e) {
            e.preventDefault();

            var formData = new FormData(this);
            $('#loadingModal').modal('show');

            $.ajax({
                url: '/upload/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    showSnackbar("File uploaded successfully!");
                    $('#loadingModal').modal('hide');
                    // Fetch updated list of files
                    fetchFiles();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    showSnackbar("Failed to upload file: " + errorThrown);
                    $('#loadingModal').modal('hide');
                }
            });
        });

        $('#searchField').on('input', function() {
            var query = $(this).val();
            fetchFiles(query);
        });

        function showSnackbar(message) {
            var snackbar = $('#snackbar');
            snackbar.text(message);
            snackbar.addClass('show');
            setTimeout(function() {
                snackbar.removeClass('show');
            }, 3000);
        }
    });
</script>

{% endblock %}
